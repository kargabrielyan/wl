# E‑commerce Platform — Technical Decisions (MVP v0.1)

Ниже — конкретные решения по пяти пунктам: цель MVP, пиковые нагрузки и SLA/SLO, архитектура, инфраструктура, KPI/Roadmap. Формат — «что делаем → почему → как проверяем».

---

## 0) Цель MVP
**Что:** единая «профессиональная база» интернет‑магазина, которую можно быстро клонировать под нового клиента: меняем тему, логотип, цвета, минимальные настройки и опционально включаем нужные модули.  
**Почему:** 90% кейсов — до 1000 SKU и до 1000 заказов/мес. Бизнесу важна скорость запуска и стабильность.  
**Как проверяем:** time‑to‑launch для нового бренда ≤ 3 рабочих дня при готовом контенте; смена темы без редеплоя; чек‑лист перенастройки ≤ 30 шагов.

---

## 1) Пиковые нагрузки и SLA/SLO
**Базовые допущения:**
- 79% клиентов: до 100 заказов/мес. 20%: до 1000. 1%: до 10 000.  
- Пиковая нагрузка по просмотрам в 10–20 раз выше, чем по заказам.  

**SLA (цель по доступности):** 99.9% в месяц (≈ 43 мин допустимого простоя).  
**SLO (цели по скорости и надежности):**
- HTML TTFB p95: ≤ 300 мс из кэша CDN, ≤ 600 мс без кэша.  
- API p95: ≤ 500 мс чтение, ≤ 800 мс запись (checkout/оплата).  
- Поиск p95: ≤ 250 мс на 10k SKU.  
- Core Web Vitals p75: LCP ≤ 2.5 с, INP ≤ 200 мс, CLS ≤ 0.1.  
- Ошибки 5xx: ≤ 0.1% запросов/неделя.  

**Нагрузочное тестирование (ориентиры):**
- Browse‑чтение: выдерживать 150 RPS (пик) 10 мин без деградации SLO.  
- Checkout/запись: 5 RPS стабильно, короткие пики до 20 RPS (акции).  
**Почему так:** кратный запас на фоне заявленных объемов, но без «переархитектуры ради спорта».  
**Как проверяем:** k6/Playwright сценарии в CI, отчеты по p95/p99, алерты об ошибках бюджета.

---

## 2) Архитектура (выбор стека и модульности)
**Выбор:** TypeScript‑моно‑монолит с четкими модулями: фронт — Next.js 15 (App Router), бэкенд — NestJS (в одном репо), БД — PostgreSQL 16, кэш — Redis 7, очередь — BullMQ (Redis), поиск — Meilisearch 1.x.  
**Почему это лучше сейчас:**
- Быстрый фулл‑стек на одном языке (TS) и зрелая экосистема.  
- Для 1–10k SKU Meilisearch проще и дешевле, чем OpenSearch.  
- «Микро‑монолит» быстрее разрабатывается и поддерживается; границы модулей готовят к возможному выделению в сервисы, если когда‑нибудь вырастет до 100k+ SKU и десятков RPS на запись.  
- Laravel — сильный вариант, но TS‑стек облегчит переиспользование компонентов, SDK и типобезопасных контрактов под будущие фронты/интеграции.

**Структура монорепозитория (Turborepo + pnpm):**
- `apps/web` — Next.js (SSR/ISR, i18n, темы)
- `apps/admin` — административная панель (Next.js)
- `apps/api` — NestJS (REST/GraphQL), RBAC, валидация, вебхуки
- `packages/domain` — бизнес‑модели и правила (чистая архитектура)
- `packages/ui` — дизайн‑система, темы, компоненты
- `packages/adapters/*` — платежи (Idram, ArCa, Stripe), доставка, поиск
- `packages/sdk` — типобезопасный клиент для web/admin/интеграций

**Ключевые модули:**
- Каталог (товар, вариации, категории, бренды, атрибуты)
- Поиск/фасеты (Meilisearch, индексация фоновыми задачами)
- Корзина/Checkout (идемпотентность, расчеты, налоги)
- Оплаты (Idram/ArCa токены, предавторизация, возвраты)
- Доставка/геозоны (плоские тарифы, вес/объем)
- Контент/SEO (OG, микроразметка, sitemap, hreflang)
- Пользователи/RBAC, B2B‑профили

**Как проверяем:** модульные тесты (Vitest/Jest), e2e (Playwright), контрактные тесты API, code‑coverage ≥ 70% на ядре.

---

## 3) Инфраструктура (VPS vs Docker/k8s)
**Выбор сейчас:** VPS + Docker Compose + Cloudflare CDN/WAF.  
**Почему:**
- Ваши объемы не требуют k8s; Compose проще и дешевле, меньше точек отказа.
- Легко масштабировать по горизонтали, когда понадобится: отдельные VPS для `web`, `api`, `db`, `search`.

**Базовая схема:**
- Front (Next.js) и API (NestJS) в отдельных контейнерах за Nginx.  
- PostgreSQL (managed или выделенный VPS с регулярными бэкапами).  
- Redis для кэша/очередей.  
- Meilisearch контейнер.  
- S3‑совместимое хранилище для медиа: Cloudflare R2/Wasabi; в dev — MinIO.  
- CDN перед Nginx для кэша статики и HTML (ISR/edge‑cache).  

**Характеристики на старт:**
- PROD: 8 vCPU / 16 GB RAM (web+api), 4 vCPU / 8 GB (Meili), managed Postgres 2–4 vCPU / 8–16 GB, Redis 2 vCPU / 4 GB.  
- STAGE: 2–4 vCPU / 8 GB.  

**CI/CD:** GitHub Actions → build контейнеров → push в registry → деплой по SSH с zero‑downtime (blue‑green через два стека `web_v1/web_v2`).  
**Обсервабилити:**
- Логи: Loki/Vector + графики Grafana, алерты в Telegram.  
- Аптайм: Uptime Kuma.  
- Трейсы: OTEL (по минимуму на критичных путях).  
**Бэкапы/DR:** Postgres — ежедневно инкремент, еженедельно полный; RPO ≤ 24 ч, RTO ≤ 1 ч. Проверка восстановления раз в квартал.

---

## 4) KPI (метрики) и Roadmap
**KPI MVP:**
- Время развертывания нового магазина: ≤ 3 дня.  
- LCP p75 ≤ 2.5 c, INP p75 ≤ 200 мс, CLS p75 ≤ 0.1.  
- TTFB p95: ≤ 300 мс из кэша, ≤ 600 мс без кэша.  
- Ошибки 5xx ≤ 0.1% запросов/неделя.  
- Конверсия checkout‑шагов: drop‑off ≤ 30% между шагами.  

**Roadmap (крупные блоки):**
- **MVP (v0.1–v0.3)**: ядро каталога, поиск, корзина, checkout, Idram/ArCa, базовая доставка, i18n, SEO, админ‑панель v1, отчеты заказов.  
- **v1.1**: купоны/скидки, рефакторинг правил цен, сегментация.  
- **v1.2**: интеграции CRM/учет (Bitrix24, ՀԾ), фиды Merchant.  
- **v1.3**: B2B‑кабинет, прайс‑листы, лимиты кредитов.  
- **v1.4**: мульти‑тенант режим для агентской модели (по необходимости).  
- **v1.5**: server‑side tracking, отчеты по юнит‑экономике.  

**Как фиксируем прогресс:** релизные ноты, чек‑листы приемки, авто‑репорты Lighthouse/Playwright в CI.

---

## 5) Риски и меры
- **Платежные провайдеры**: нестабильные вебхуки → идемпотентность и повторная обработка.  
- **Импорт контента**: грязные данные → строгая валидация и отчеты об ошибках.  
- **Поиск**: рассинхронизация индекса → фоновые «rebuild» и health‑пробы.  
- **Кэш**: устаревшие страницы → точечная инвалидация по событиям (изменение цены/остатка).  
- **Рост нагрузки**: разделение `web`/`api` по VPS, вынос поиска и БД на отдельные узлы, включение read‑replica для Postgres.

---

## 6) Что входит в шаблон (Base‑Store)
- Конфигурация бренда (цвета, логотип, шрифты) через JSON/YAML.  
- Темы UI (Tailwind + токены), переключаемые без релиза.  
- Конструктор главной: hero/баннеры/гриды/коллекции.  
- Готовые страницы: главная, категория, товар, корзина, checkout, профиль, 404/500.  
- SEO‑блок: sitemap, robots, OG, Schema.org.  
- Интеграции: Idram/ArCa, базовые доставки, e‑mail/SMS провайдеры.  
- Скрипты деплоя, миграций и прогрева кэша; демо‑данные.  

> Никакой магии — только дисциплина инженерии и здравый запас по производительности.

