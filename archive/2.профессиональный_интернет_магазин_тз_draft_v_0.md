# Профессиональный интернет‑магазин — ТЗ (Draft v0.1)

Цель: один **самодостаточный** интернет‑магазин «как у взрослых», без конструкторов и мультиклиентских выкрутасов. Готовая база: каталог → поиск → корзина → checkout → оплата → заказы → админка. Проект независимый; в будущем его можно копировать и адаптировать под новый бренд.

---

## 1) Scope MVP (что входит сейчас)
- Каталог: категории, бренды, атрибуты, вариативность (цвет/размер), фото/галерея.
- Поиск и фильтры: полнотекст + фасеты, подсказки, синонимы и опечатки.
- Корзина: гостевая и авторизованная, сохранение, брошенные корзины (e‑mail).
- Checkout: одноэкранный (one‑page) с минимальными полями и валидациями.
- Оплата: Idram, ArCa (3‑DS), токенизация карт для повторных платежей.
- Доставка: самовывоз, курьер по городу, фикс по стране; геозоны, free‑shipping правила.
- ЛК пользователя: профиль, адреса, история заказов, повторы.
- Заказы (OMS): статусы, комментарии менеджера, уведомления e‑mail/SMS.
- Контент и SEO: блог/новости, OG/Schema.org, hreflang, карта сайта, robots.
- Админка: CRUD товаров/категорий/атрибутов, массовые операции, медиа‑менеджер, заказы, купоны.

**Out of scope (после релиза):** реферальная программа, B2B‑прайсы, marketplace‑фиды, много‑склад, возвраты с RMA‑кабинетом.

---

## 2) Нефункциональные требования (SLA/SLO)
- **Доступность (SLA):** 99.9%/мес (допустимый простой ≈ 43 мин).
- **Скорость (SLO):**
  - TTFB p95: ≤ 300 мс из кэша CDN, ≤ 600 мс без.
  - LCP p75 ≤ 2.5 c, INP p75 ≤ 200 мс, CLS p75 ≤ 0.1.
  - API чтение p95 ≤ 500 мс; запись p95 ≤ 800 мс (checkout/оплата).
  - Поиск p95 ≤ 250 мс на каталоге до 10k SKU.
- **Ошибки:** 5xx ≤ 0.1% запросов в неделю.
- **Безопасность:** OWASP ASVS базовый уровень, CSP, CSRF, XSS‑защита, rate‑limit, WAF.
- **Логи/мониторинг:** структурированные логи, алерты, аптайм‑пинги.

---

## 3) Архитектура и стек
**Выбор:** TypeScript «микро‑монолит» без лишней магии.
- Витрина: **Next.js 15 (App Router, SSR/ISR)**.
- API/бэкенд: **NestJS** (REST + вебхуки), RBAC.
- БД: **PostgreSQL 16**, миграции (Prisma/Drizzle), транзакции.
- Кэш/сессии/очереди: **Redis 7**, BullMQ для фона (e‑mail, индексация, вебхуки).
- Поиск: **Meilisearch 1.x** (индексация фоновыми задачами).
- Медиа: S3‑совместимое хранилище (Cloudflare R2/Wasabi), CDN.
- I18n: серверная локализация RU/AM/EN, мультиязычные URL.

**Почему так:** один язык (TS) на фронте и бэке, быстрый dev‑цикл, хватает на 1–10k SKU и до 10k заказов/мес с разумным запасом.

> Альтернатива: Laravel 11 + Livewire/Blade на витрине. Возможна, но базовый выбор — TS.

---

## 4) Доменная модель (ядро)
- **Product** (id, slug, title, description, media, brandId).  
- **Variant** (sku, options[], price, compareAt, stock, barcode).  
- **Category** (tree, slug, meta).  
- **Attribute/Value** (фасеты).  
- **Cart** (items[], totals, coupons).  
- **Order** (number, userId, items[], totals, status, payments[], shipments[]).  
- **User** (auth, profiles, addresses).  
- **Coupon** (code, rules, validity).  

Все сущности — с audit полями, soft‑delete там, где оправдано.

---

## 5) Ключевые пользовательские потоки
1. **Browse/Search:** категория → фильтры → сортировки → карточка товара.
2. **Cart:** добавление/изменение/удаление, промокод, пересчет.
3. **Checkout:** контактные данные → адрес/доставка → оплата → подтверждение.
4. **Оплата:** редирект/виджет провайдера, webhooks, идемпотентность.
5. **Заказ:** письмо‑подтверждение, смена статусов, трекинг для клиента.

---

## 6) Админ‑панель (v1)
- Товары/категории/атрибуты: формы с валидацией, массовые правки, импорт CSV.
- Заказы: список, фильтры, смена статусов, комментарии, печать документов.
- Купоны: простые правила (фикс/процент, минимум корзины, дата/количество).
- Пользователи: поиск, блокировка, сброс пароля.
- Настройки магазина: локали, валюта, налоги, доставка, e‑mail шаблоны.

---

## 7) Интеграции
- **Платежи:** Idram, ArCa (обязательны в MVP).  
- **Доставка:** базовые тарифы + экспорт ярлыков позже.  
- **Аналитика:** GA4 + server‑side events (минимум purchase/checkout).  
- **CRM/учет:** отложено на v1.2 (Bitrix24/ՀԾ через адаптеры).

---

## 8) Инфраструктура и деплой
- Хостинг: VPS. Фронт и API как контейнеры за Nginx, Redis/Meili отдельными контейнерами.
- БД: управляемый Postgres либо выделенный VPS с бэкапами.
- CDN/WAF: Cloudflare. HTML/статика под кэш; инвалидация по событиям.
- Начальные размеры: web+api 8 vCPU/16 GB, Meili 4 vCPU/8 GB, Redis 2 vCPU/4 GB, Postgres 2–4 vCPU/8–16 GB.
- CI/CD: GitHub Actions, zero‑downtime деплой (blue‑green), миграции на релизе.
- Обсервабилити: Loki/Prometheus/Grafana, алерты в Telegram, Uptime‑пинги.
- Бэкапы: ежедневные инкрементальные + еженедельные полные; ежеквартальные тесты восстановления.

---

## 9) Тесты и качество
- Unit (ядро домена) и API‑контракты: покрытие ≥ 70% ядра.
- E2E (Playwright): поиск, корзина, checkout, оплата, смена статуса заказа.
- Нагрузочное (k6): 100–150 RPS чтение, 5–20 RPS запись на коротких пиках.
- Авто‑Lighthouse: отчеты на PR, бюджет производительности.

---

## 10) KPI релиза и Roadmap
- **KPI v1.0:** time‑to‑first‑byte p95 ≤ 600 мс без кэша; LCP p75 ≤ 2.5 c;
  конверсия checkout step‑to‑step drop‑off ≤ 30%; время деплоя ≤ 30 мин.
- **v1.1:** купоны/скидки расширенные, wishlist, сравнение, экспорт фидов.
- **v1.2:** CRM/учет (Bitrix24/ՀԾ), возвраты (RMA), экспорт ярлыков курьеров.
- **v1.3:** B2B‑цены, прайс‑листы, ограничение кредитов.

---

## 11) Передача и документация
- Readme для запуска (dev/stage/prod), .env шаблоны.
- Схемы БД и ERD, описание событий и вебхуков.
- Руководство администратора (короткое), чек‑лист запуска.

> Итог: это не «конструктор», а единый профессиональный проект. Но он достаточно аккуратный, чтобы его можно было копировать и быстро адаптировать под другой бренд без повторного изобретения велосипеда.

